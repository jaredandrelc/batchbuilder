<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Batch Builder</title>
    <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' height='24' viewBox='0 -960 960 960' width='24' fill='%23007AFF'%3E%3Cpath d='M160-160q-33 0-56.5-23.5T80-240v-480q0-33 23.5-56.5T160-800h640q33 0 56.5 23.5T880-720v480q0 33-23.5 56.5T800-160H160Zm0-80h640v-480H160v480Zm160-120h320v-80H320v80Zm-80-160 160-160-160-160-56 56 104 104-104 104 56 56ZM160-240v-480 480Z'/%3E%3C/svg%3E">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Fira+Code:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/default.css">
    <script src="https://cdn.jsdelivr.net/npm/mobile-drag-drop@2.3.0-rc.2/index.min.js"></script>
</head>
<body>

    <!-- NAVBAR -->
    <nav class="navbar">
        <div class="navbar-brand" onclick="openModal('aboutModal')">
            <span class="material-symbols-rounded" style="font-size: 26px;">terminal</span>
            Batch Builder
        </div>
        
        <div class="nav-controls">
            <div class="btn-group-pill">
                <button class="btn-action secondary" onclick="document.getElementById('fileInput').click()" aria-label="Open File">
                    <span class="material-symbols-rounded" style="font-size: 18px; margin-right: 6px;">folder_open</span> <span class="btn-text">Open</span>
                </button>
                <div class="pill-divider"></div>
                <button class="btn-action secondary" onclick="saveDraft()" aria-label="Save Draft">
                    <span class="material-symbols-rounded" style="font-size: 18px; margin-right: 6px;">save</span> <span class="btn-text">Save</span>
                </button>
            </div>
            <input type="file" id="fileInput" accept=".dbat,.bat,.cmd,.txt" style="display: none" onchange="loadFile(this)">

            <!-- Rounded Settings Button -->
            <button class="btn-icon" style="border-radius: 50%; width: 40px; height: 40px;" onclick="openModal('settingsModal')" aria-label="Settings">
                <span class="material-symbols-rounded">settings</span>
            </button>

            <button class="btn-action secondary" onclick="copyToClipboard()" aria-label="Copy to Clipboard">
                <span class="material-symbols-rounded">content_copy</span> <span class="btn-text">Copy</span>
            </button>
            <button class="btn-action" onclick="exportBatch()" aria-label="Export to BAT">
                <span class="material-symbols-rounded">download</span> <span class="btn-text">Export .BAT</span>
            </button>
        </div>
        
        <button class="navbar-toggler" onclick="toggleMobileMenu()" aria-label="Menu">
            <span class="material-symbols-rounded">menu</span>
        </button>
    </nav>

    <!-- MAIN LAYOUT -->
    <div class="main-container">
        <!-- Main Sidebar -->
        <div class="sidebar" id="mainSidebar">
            <div class="segmented-control">
                <div class="segment-tab active" onclick="switchTab('commands')" id="tabBtn-commands">Commands</div>
                <div class="segment-tab" onclick="switchTab('presets')" id="tabBtn-presets">Presets</div>
            </div>

            <input type="text" class="search-box" placeholder="Search commands..." id="searchInput" onkeyup="filterCommands()" aria-label="Search">
            
            <!-- Sub Sidebar (Icons) -->
            <div class="sub-sidebar">
                <div class="context-icon" id="ctx-all" onclick="switchContext('All')" title="All Commands" aria-label="All Commands">
                    <span class="material-symbols-rounded">apps</span>
                </div>
                <div class="context-icon active" id="ctx-batch" onclick="switchContext('Batch')" title="Batch Commands" aria-label="Batch Commands">
                    <span class="material-symbols-rounded">terminal</span>
                </div>
                <div class="context-icon" id="ctx-python" onclick="switchContext('Python')" title="Python Commands" aria-label="Python Commands">
                    <span class="material-symbols-rounded">code</span>
                </div>
                <div class="context-icon" id="ctx-java" onclick="switchContext('Java')" title="Java Commands" aria-label="Java Commands">
                    <span class="material-symbols-rounded">coffee</span>
                </div>
                <div class="context-icon" id="ctx-git" onclick="switchContext('Git')" title="Git Commands" aria-label="Git Commands">
                    <span class="material-symbols-rounded">call_merge</span>
                </div>
                <div class="context-icon" id="ctx-archive" onclick="switchContext('Archive')" title="Archive Commands" aria-label="Archive Commands">
                    <span class="material-symbols-rounded">archive</span>
                </div>
            </div>

            <div class="sidebar-content">
                <div id="tab-commands" class="tab-pane active">
                    <div id="sidebar-warning"></div>
                    <div id="pinnedList"></div>
                    <div id="commandList"></div>
                </div>
                <div id="tab-presets" class="tab-pane">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; font-weight: 600;">My Presets</div>
                    <div id="customPresetList"></div>
                    <hr style="border-color: var(--border-color); margin: 15px 0;">
                    <div style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 10px; font-weight: 600;">Templates</div>
                    <div id="presetList"></div>
                </div>
            </div>
        </div>

        <!-- Canvas -->
        <div class="canvas-area">
            <div class="canvas-ribbon">
                <div class="ribbon-group">
                    <!-- Undo/Redo Joined Pill -->
                    <div class="ribbon-pill-group">
                        <button class="ribbon-pill-btn" onclick="undo()" id="btnUndo" disabled title="Undo (Ctrl+Z)" aria-label="Undo">
                            <span class="material-symbols-rounded" style="font-size: 20px;">undo</span>
                        </button>
                        <div class="pill-divider"></div>
                        <button class="ribbon-pill-btn" onclick="redo()" id="btnRedo" disabled title="Redo (Ctrl+Y)" aria-label="Redo">
                            <span class="material-symbols-rounded" style="font-size: 20px;">redo</span>
                        </button>
                    </div>

                    <div style="width: 1px; height: 16px; background: var(--border-color); margin: 0 4px;"></div>
                    
                    <!-- Clear with Popover -->
                    <button class="ribbon-btn" id="btnClear" onclick="toggleClearPopover(event)" aria-label="Clear Canvas">
                        <span class="material-symbols-rounded" style="font-size: 18px;">delete</span> <span class="btn-text">Clear</span>
                    </button>
                </div>

                <div class="ribbon-group">
                    <button class="ribbon-btn" style="color:var(--text-secondary); font-size:0.8rem; display:flex; gap:6px; align-items:center; background:none; border:none; cursor:pointer;" onclick="openSavePresetModal()" aria-label="Save as Preset">
                        <span class="material-symbols-rounded" style="font-size: 18px;">bookmark_add</span> <span class="btn-text">Save as Preset</span>
                    </button>
                    <div style="width: 1px; height: 16px; background: var(--border-color); margin: 0 4px;"></div>
                    
                    <!-- Overview Button (Visible only in Block view) -->
                    <button class="ribbon-btn" id="btnOverview" style="color:var(--text-secondary); font-size:0.8rem; display:flex; gap:6px; align-items:center; background:none; border:none; cursor:pointer;" onclick="toggleOverview()" aria-label="Toggle Overview Mode">
                        <span class="material-symbols-rounded" style="font-size: 18px;">compress</span> <span class="btn-text">Overview</span>
                    </button>

                    <!-- View Toggle -->
                    <div class="view-toggle">
                        <div class="view-option active" id="view-block" onclick="toggleView('block')" aria-label="Block View">
                            <span class="material-symbols-rounded" style="font-size: 16px;">view_agenda</span> <span class="btn-text">Blocks</span>
                        </div>
                        <div class="view-option" id="view-code" onclick="toggleView('code')" aria-label="Code View">
                            <span class="material-symbols-rounded" style="font-size: 16px;">code</span> <span class="btn-text">Script</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Toast Anchor -->
            <div class="toast-container" id="toastContainer"></div>

            <!-- Block View -->
            <div class="canvas-scroller" id="blockViewContainer">
                <div class="drop-zone" id="dropZone">
                    <div style="text-align: center; margin-top: 20vh;" id="emptyState">
                        <span class="material-symbols-rounded" style="font-size: 64px; color: var(--border-color);">drag_indicator</span>
                        <p class="mt-3" style="color: var(--text-secondary);">Start Building</p>
                        <button class="btn-secondary-action" style="margin: 12px auto;" onclick="loadExample()">Load Basic Example</button>
                    </div>
                </div>
            </div>

            <!-- Code View -->
            <div class="code-view-container" id="codeViewContainer">
                <div id="codePreviewBlock" style="height: 100%;"></div>
            </div>

            <!-- Floating Help Button -->
            <a href="https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/windows-commands" target="_blank" class="fab-help" title="Microsoft Learn: Batch" aria-label="Help">
                <span class="material-symbols-rounded">question_mark</span>
            </a>
        </div>
    </div>

    <!-- Script Editor Modal -->
    <div class="modal-overlay" id="scriptEditorModal">
        <div class="modal-box large">
            <div class="modal-header">
                <div class="modal-title">Edit Python Script</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('scriptEditorModal')">close</span>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.85rem; margin-bottom: 12px;">Content will be generated into the file specified in the block.</p>
            <textarea id="scriptContentArea" class="script-editor-area" placeholder="print('Hello World')"></textarea>
            <div class="modal-footer">
                <button class="btn-secondary-action" onclick="closeModal('scriptEditorModal')">Cancel</button>
                <button class="btn-action" onclick="saveScriptContent()">Save Script</button>
            </div>
        </div>
    </div>

    <!-- Rename Modal -->
    <div class="modal-overlay" id="renameModal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Rename Preset</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('renameModal')">close</span>
            </div>
            <div style="margin-bottom:16px;">
                <label class="form-label">Name</label>
                <input type="text" id="renameInput" class="form-control" placeholder="New name..." oninput="this.classList.remove('invalid')">
                <div class="validation-msg"><span class="material-symbols-rounded" style="font-size:12px">error</span> Name is required</div>
            </div>
            <label class="form-label">Change Icon</label>
            <div class="icon-grid" id="renameIconGrid">
                <!-- JS populated -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary-action" onclick="closeModal('renameModal')">Cancel</button>
                <button class="btn-action" onclick="confirmRename()">Save</button>
            </div>
        </div>
    </div>

    <!-- Save Preset Modal -->
    <div class="modal-overlay" id="savePresetModal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Save as Preset</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('savePresetModal')">close</span>
            </div>
            <div style="margin-bottom:16px;">
                <label class="form-label">Preset Name</label>
                <input type="text" id="presetNameInput" class="form-control" placeholder="My Awesome Script" oninput="this.classList.remove('invalid')">
                <div class="validation-msg"><span class="material-symbols-rounded" style="font-size:12px">error</span> Name is required</div>
            </div>
            <label class="form-label">Select Icon</label>
            <div class="icon-grid" id="presetIconGrid">
                <!-- Populated by JS -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary-action" onclick="closeModal('savePresetModal')">Cancel</button>
                <button class="btn-action" onclick="confirmSavePreset()">Create Preset</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal-box">
            <div class="modal-header" style="display:flex; justify-content:space-between;">
                <div class="modal-title">Settings</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('settingsModal')">close</span>
            </div>
            
            <div class="settings-category">Appearance</div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">Theme</div>
                    <div class="setting-desc">Select your preferred appearance</div>
                </div>
                <select class="form-select" style="width: 120px;" id="themeSelect" onchange="changeTheme(this.value)">
                    <option value="system">System</option>
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                </select>
            </div>

            <div class="settings-category">Config</div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">Compact Sidebar</div>
                    <div class="setting-desc">Smaller icons in the command list</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="sidebarCompactToggle" onchange="toggleSidebarCompact()">
                    <span class="slider"></span>
                </label>
            </div>
            <div class="setting-item">
                <div>
                    <div class="setting-label">Show Welcome Screen</div>
                    <div class="setting-desc">Show the welcome popup on every startup</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="welcomeToggle" onchange="toggleWelcomeEveryTime()">
                    <span class="slider"></span>
                </label>
            </div>
            <p style="color:var(--text-secondary); font-size: 0.85rem; margin-top: 20px;">All command suites (Git, Python, SysAdmin) are enabled.</p>
            <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px;">
                <button class="btn-secondary-action" style="flex: 1; justify-content: center;" onclick="openModal('aboutModal')">About App</button>
                <button class="btn-secondary-action" style="flex: 1; justify-content: center;" onclick="openModal('privacyModal')">Privacy Policy</button>
            </div>
        </div>
    </div>

    <!-- Validation Error Modal -->
    <div class="modal-overlay" id="errorModal">
        <div class="modal-box" style="text-align: center; width: 400px;">
            <div style="margin-bottom: 16px;">
                <span class="material-symbols-rounded" style="color: var(--warning-color); font-size: 48px;">warning</span>
            </div>
            <h3 style="margin-bottom: 10px; font-size: 1.2rem; font-weight: 600;">Validation Issues</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 24px;">
                Your script contains empty fields, undefined variables, or logic errors.
            </p>
            <div class="modal-footer" style="justify-content: center; gap: 10px;">
                <button class="btn-secondary-action" onclick="closeModal('errorModal')">Cancel</button>
                <button class="btn-action" onclick="proceedWithAction()">Proceed Anyway</button>
            </div>
        </div>
    </div>

    <!-- Welcome / Onboarding Modal -->
    <div class="modal-overlay" id="welcomeModal">
        <div class="modal-box" style="width: 850px; max-width: 95vw;">
            <div class="modal-header">
                <div class="modal-title">Welcome to Batch Builder</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('welcomeModal')">close</span>
            </div>
            
            <!-- Step 1: Intro -->
            <div id="welcome-step-1">
                <div class="welcome-grid">
                    <div class="welcome-step">
                        <div class="step-icon"><span class="material-symbols-rounded">touch_app</span></div>
                        <div class="step-title">1. Select</div>
                        <div class="step-desc">Browse commands from the sidebar categories.</div>
                    </div>
                    <div class="welcome-step">
                        <div class="step-icon"><span class="material-symbols-rounded">drag_indicator</span></div>
                        <div class="step-title">2. Drag</div>
                        <div class="step-desc">Drag blocks onto the canvas to build your logic.</div>
                    </div>
                    <div class="welcome-step">
                        <div class="step-icon"><span class="material-symbols-rounded">download</span></div>
                        <div class="step-title">3. Export</div>
                        <div class="step-desc">Download your finished script as a .BAT file.</div>
                    </div>
                </div>
            </div>

            <!-- Step 2: Configuration -->
            <div id="welcome-step-2" style="display: none;">
                <p style="text-align: center; color: var(--text-secondary);">Choose your preferred sidebar layout.</p>
                <div class="mode-selection">
                    <div class="mode-card selected" id="card-normal" onclick="selectWelcomeMode('normal')">
                        <div class="step-icon"><span class="material-symbols-rounded">view_list</span></div>
                        <div class="mode-title">Normal Mode</div>
                        <div class="mode-desc">Standard view with command descriptions. Best for beginners.</div>
                    </div>
                    <div class="mode-card" id="card-compact" onclick="selectWelcomeMode('compact')">
                        <div class="step-icon"><span class="material-symbols-rounded">grid_view</span></div>
                        <div class="mode-title">Compact Mode</div>
                        <div class="mode-desc">Dense view with icons only. Best for experienced users.</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="btn-secondary-action" id="welcomeBackBtn" onclick="prevWelcomeStep()" style="display: none;">Back</button>
                <button class="btn-action" id="welcomeNextBtn" onclick="nextWelcomeStep()">Next</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="aboutModal">
        <div class="modal-box" style="text-align: center;">
            <span class="material-symbols-rounded close-modal" style="float: right; cursor:pointer;" onclick="closeModal('aboutModal')">close</span>
            <div style="margin-bottom: 20px; margin-top: 10px;">
                <span class="material-symbols-rounded" style="color: var(--accent-color); font-size: 48px;">terminal</span>
            </div>
            <h3>Batch Builder</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">The advanced visual batch script editor.</p>
            <div style="margin-top:20px; font-size:0.8rem; color: var(--text-secondary);">Jared Andre Carreon Â© <span id="yearSpan"></span></div>
        </div>
    </div>

    <div class="modal-overlay" id="privacyModal">
        <div class="modal-box">
            <div class="modal-header">
                <div class="modal-title">Privacy Policy</div>
                <span class="material-symbols-rounded close-modal" style="cursor:pointer;" onclick="closeModal('privacyModal')">close</span>
            </div>
            <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.6;">
                <p>Batch Builder is a client-side application.</p>
                <ul style="padding-left: 20px; margin-top: 8px; margin-bottom: 0;">
                    <li>This app does not collect, store, or transmit any personal data.</li>
                    <li>No tracking cookies or analytics are used.</li>
                    <li>All your scripts and settings remain on your device.</li>
                </ul>
            </div>
            <div class="modal-footer">
                <button class="btn-action" onclick="closeModal('privacyModal')">Close</button>
            </div>
        </div>
    </div>

    <div id="dragGhost" class="ghost-drag">
        <div style="display: flex; align-items: center; gap: 10px;">
            <span class="material-symbols-rounded" id="ghostIcon">code</span>
            <span id="ghostText">Command</span>
        </div>
    </div>

    <div id="clearPopover" class="popover-confirm">
        <div class="popover-text">Delete all blocks?</div>
        <div class="popover-actions">
            <button class="btn-sm-secondary" onclick="toggleClearPopover()">Cancel</button>
            <button class="btn-sm-danger" onclick="confirmClear()">Clear</button>
        </div>
    </div>

    <div id="deletePresetPopover" class="popover-confirm">
        <div class="popover-text">Delete this preset?</div>
        <div class="popover-actions">
            <button class="btn-sm-secondary" onclick="closeDeletePresetPopover()">Cancel</button>
            <button class="btn-sm-danger" onclick="confirmDeletePreset()">Delete</button>
        </div>
    </div>

    <!-- Mobile Menu -->
    <div class="mobile-menu" id="mobileMenu">
        <div class="mobile-menu-header">
            <span class="material-symbols-rounded" style="font-size: 24px;">terminal</span>
            <span style="font-weight: 600;">Menu</span>
            <span class="material-symbols-rounded close-menu" onclick="toggleMobileMenu()">close</span>
        </div>
        <div class="mobile-menu-items">
            <button class="mobile-btn" onclick="document.getElementById('fileInput').click(); toggleMobileMenu()">
                <span class="material-symbols-rounded">folder_open</span> Open File
            </button>
            <button class="mobile-btn" onclick="saveDraft(); toggleMobileMenu()">
                <span class="material-symbols-rounded">save</span> Save Draft
            </button>
            <button class="mobile-btn" onclick="openModal('settingsModal'); toggleMobileMenu()">
                <span class="material-symbols-rounded">settings</span> Settings
            </button>
            <button class="mobile-btn" onclick="copyToClipboard(); toggleMobileMenu()">
                <span class="material-symbols-rounded">content_copy</span> Copy Script
            </button>
            <button class="mobile-btn primary" onclick="exportBatch(); toggleMobileMenu()">
                <span class="material-symbols-rounded">download</span> Export .BAT
            </button>
        </div>
    </div>

    <script src="data.js"></script>
    <script src="linter.js"></script>
    <script src="script.js"></script>
</body>
</html>